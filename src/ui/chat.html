<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Kimi Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    *{box-sizing:border-box;font-family:sans-serif}
    body{margin:0;padding:8px;background:#1e1e1e;color:#eee;height:100vh;display:flex;flex-direction:column}
    #log{flex:1;overflow-y:auto;border:1px solid #333;padding:4px;margin-bottom:6px}
    #inputWrap{display:flex}
    #msg{flex:1;padding:6px;border:none;border-radius:4px 0 0 4px}
    #send{padding:6px 12px;border:none;background:#0a84ff;color:#fff;border-radius:0 4px 4px 0}
  </style>
</head>
<body>
  <div id="log"></div>
  <div id="inputWrap">
    <input id="msg" placeholder="Ask Kimi…" />
    <button id="send">Send</button>
  </div>
  <script type="module">
    import { askKimi } from "../lib/api.js";
    import { get, set } from "../lib/storage.js";

    const log = document.getElementById("log");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("send");
    const API_KEY = get("apiKey");

    if (!API_KEY) {
      log.textContent = "⚠️ Open the plugin settings and add your API key first.";
    }

    function append(role, txt) {
      const div = document.createElement("div");
      div.innerHTML = `<strong>${role}:</strong> ${txt}`;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    async function send() {
      const text = input.value.trim();
      if (!text) return;
      append("You", text);
      input.value = "";
      try {
        const reply = await askKimi([{ role: "user", content: text }], API_KEY);
        append("Kimi", reply);
      } catch (e) {
        append("Error", e.message);
      }
    }

    sendBtn.onclick = send;
    input.onkeydown = (e) => e.key === "Enter" && !e.shiftKey && (send(), e.preventDefault());
  </script>
</body>
</html>
